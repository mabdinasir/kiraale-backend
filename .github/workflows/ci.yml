name: CI Pipeline

on:
    push:
        branches:
            - main # Trigger only on direct pushes to the main branch
    pull_request:
        branches:
            - main # Trigger when a PR is merged into main
        types:
            - closed # Only trigger on PR closure (merge)

jobs:
    lint-and-format:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '22'

            - name: Install Bun
              run: curl -fsSL https://bun.sh/install | bash
              env:
                  BUN_INSTALL: /home/runner/.bun

            - name: Add Bun to PATH
              run: echo "/home/runner/.bun/bin" >> $GITHUB_PATH

            - name: Install dependencies
              run: bun install

            - name: Run ESLint
              run: bun run lint

            - name: Run Prettier
              run: bun run fmt:check

    build-and-push:
        runs-on: ubuntu-latest
        needs: lint-and-format # Make sure linting and formatting are done first

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v2

            - name: Log in to AWS ECR
              uses: aws-actions/amazon-ecr-login@v2
              with:
                  region: ${{ secrets.EASTLEIGH_REAL_ESTATE_ECS_REGION }}

            - name: Set up AWS CLI
              uses: aws-actions/configure-aws-credentials@v2
              with:
                  aws-access-key-id: ${{ secrets.EASTLEIGH_REAL_ESTATE_ECS_ACCESS_KEY_ID }}
                  aws-secret-access-key: ${{ secrets.EASTLEIGH_REAL_ESTATE_ECS_SECRET_ACCESS_KEY }}
                  aws-region: ${{ secrets.EASTLEIGH_REAL_ESTATE_ECS_REGION }}

            - name: Build Docker image
              run: |
                  docker build -t ${{ secrets.EASTLEIGH_REAL_ESTATE_ECS_REPOSITORY_URI }}:latest .

            - name: Push Docker image to ECR
              run: |
                  docker push ${{ secrets.EASTLEIGH_REAL_ESTATE_ECS_REPOSITORY_URI }}:latest
